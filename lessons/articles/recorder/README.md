### Recorder — запись событий в Home Assistant, контроль базы данных

:arrow_right: [Вернуться к оглавлению](https://alexkvazis.blogspot.com/p/blog-page.html#git)

По умолчанию Home Assistant хранит полную историю всех событий и состояний для всех сущностей системы в течение 10 дней. Увидеть эту информацию вы можете на вкладках История и Журнал событий, эти интеграции также включены в стандартной конфигурации. А компонент который занимается записью — называется **Recorder**.    
Штатная база данных Home Assistant создается в формате SQLite и размещается в файле `/config/home-assistant_v2.db.`    
Чем больше сущностей в вашей системе — тем больше его объем, что логично. Контролировать его можно как визуально — например через аддон **File Editor**, которым я кстати и пользуюсь для редактирования файлов в Home Assistant или через сетевой диск **Samba**, но удобнее всего будет создать специальный сенсор.    
Для этого в файле `configuration.yaml` нужно сначала разрешить доступ к папке `/config`, если это конечно не сделано ранее — в разделе `homeassistant`, создаем список разрешенных директорий `allowlist_external_dirs` в котором и указываем путь к этой папке, вот так.

```yaml
homeassistant:
  allowlist_external_dirs:
    - /config
```
Далее переходим в меню `Настройки - Устройства и службы - Интеграции`, добавляем интеграцию `Размер файла` и указываем путь 

```yaml
/config/home-assistant_v2.db
```
При записи всего подряд, даже на небольших инсталляциях, база будет занимать сотни мегабайт, а то и гигабайты. Чем больше база — тем больше ресурсов системы необходимо для ее работы, тем тяжелее становятся бекапы, а при использовании карт памяти — намного быстрее расходуется их ресурс.    
Еще один интересный момент — сам по себе recorder не является критическим компонентом системы, так как хранит только исторические данные, Home Assistant будет работать и без него. А если физически удалить файл `home-assistant_v2.db` — новая, пустая база будет создана при следующей перезагрузке.    
Давайте разберемся как настроить этот компонент, чтобы оптимизировать объем базы, хранить только нужные сущности и избавится от мусора.    
В файле `configuration.yaml` нужно создать раздел recorder, в котором мы и будем указывать параметры хранения данных. Это можно сделать просто написав  
```yaml
recorder:
```
Тогда все параметры мы будем указывать в этом же файле. Либо вынести в отдельный файл, в котором будут хранится только данные имеющие отношение к этому компоненту. Это позволит не усложнять чрезмерно главный конфиг `configuration.yaml`, в котором и так хранится много всего. Например так:
```yaml
recorder: !include includes/recorder.yaml
```
В этом случае нужно в корневой папке `/config`, где находится `configuration.yaml`, нужно создать папку `includes` в которой создаем файл `recorder.yaml`.    
С точки зрения системы, все что находится в нем, аналогично тому, что бы мы писали в `configuration.yaml` после `recorder:`.    
Помним про правила отступов — раздел, то есть `recorder:` — не имеет отступов слева, все что входит в него, точнее вложено в него — должно иметь отступы. Сколько отступов — не важно, главное чтобы они четко отображали вложенность разделов и параметров.    
Давайте разберемся что можно настроить в этом компоненте. Я остановлюсь на наиболее, с моей точки зрения полезных.   
`db_url` — путь к базе данных. Если вы используете базу по умолчанию, он не обязателен.    
Компонент `recorder` умеет работать с базами разных форматов, и данный параметр нужен именно для указания формата и пути к базе. В данной статье я не буду подробно рассматривать этот вопрос, для примера лишь укажу как будет выглядеть настройка, если явно указать базу `SQLite` и путь к файлу.
```yaml
recorder:
  db_url: sqlite:////config/home-assistant_v2.db
```
Еще раз про правила отступов, так как это наиболее распространенная проблема при конфигурировании — они должны соблюдаться не важно какой путь вы выбрали, все писать в одном файле или вынести во внешний. То есть первая строка в файле `recorder.yaml` ( если после `recorder` будет прописан `!include includes/recorder.yaml` ) будет

```yaml
  db_url: sqlite:////config/home-assistant_v2.db
```
С отступом слева, мы просто продолжаем писать в нем то, что писали бы в `configuration.yaml`.    
Надеюсь с этим все понятно, и далее я буду давать примеры уже без разделения по способу хранения — в одном файле или с использованием вложенного.    
`auto_purge` — это параметр автоматического сжатия базы данных, очищает базу от старых данных (например при хранении 10 дней — за день, ставший 11м ) каждую ночь в 04:12 по местному времени. Он по умолчанию включен и в большинстве случаев можно просто не указывать этот параметр. Но в случае если вам такой алгоритм не подходит — его можно отключить. Но тогда нужно будет предусмотреть вариант ручного сжатия базы.    
```yaml
recorder:
  auto_purge: false
```
`purge_keep_days` — еще один необязательный (в смысле его можно не прописывать) параметр, который регулирует количество дней хранения истории. По умолчанию, как я сказал ранее — 10 дней. Если вы желаете его изменить, укажите нужное число. Все перечисленные выше параметры имеют одинаковую степень вложенности в разделе `recorder`.    
Пример с указанием явного пути к БД и хранением данных 7 дней.    

```yaml
recorder:
  db_url: sqlite:////config/home-assistant_v2.db
  purge_keep_days: 7
```
Теперь перейдем к главным параметрам настройки — описанием того что нужно включать в запись истории, а что нет.    
Для этого служат параметры (кстати того же уровня вложенности что и указанные выше) — `include` — для включения в запись и `exclude` для исключения.    
Внутри каждого из этих параметров, для указания конкретных сущностей, есть следующие варианты настроек (вы можете использовать как их все, так и по отдельности).
`domains` — для доменов целиком.    
`entity_globs` — для выбора сущностей по шаблону    
`entities`  — для выбора конкретных сущностей.    
Для того чтобы было понятнее — покажу все на живых примерах.    
Разберем по строкам, все что входит в раздел `recorder` —
```yaml
recorder:
  db_url: sqlite:////config/home-assistant_v2.db
  purge_keep_days: 14
  include:
    domains:
      - climate
      - light
    entity_globs:
      - sensor.*_power
      - sensor.*_energy
    entities:
      - sensor.home_assistant_v2_db
  exclude:
    entities:
      - light.enter_light
      - light.toilet_light
```
Указан формат и путь к файлу базы данных.    
Данные будут хранится 14 дней.    
Раздел в котором перечислено все что нужно хранить (все остальное, что не попало в него, сохраняться не будет).    
Список доменов — это все сущности, названия которых начинаются с этого слова.    
Все сущности `climate` — для термостатов    
Все сущности `light` — для светильников    
Выбор сущностей по шаблону —    
Все сенсоры мощности, название которых заканчивается на `_power`    
Все сенсоры потребления, название которых заканчивается на `_energy`    
Выбор конкретных сущностей    
Файл объема базы данных, создание которого мы рассмотрели в этой статье.    
Раздел для исключений — применяется для того чтобы исключить некоторые сущности, которые попадают под условия описанные в разделе `include`, но которые нет необходимости хранить. Этот раздел не обязательный.    
Выбор конкретных сущностей.    
Далее, для примера, указаны два светильника, которые попали под правило — хранить все сущности домена `light`, но которые мы хотим исключить.    
Еще один момент, полезный для тех, кто использует `Packages` — это очень удобный способ организации данных в Home Assistant (я и сам перехожу полностью на него) — позволяющий компоновать в одном файле конфигурации различных компонентов — например объектов, автоматизаций, скриптов, кастомизации.    
Урок по ним можно посмотреть тут - [Home Assistant. Урок 10.1 Практические кейсы — Packages, работа с освещением.](https://youtu.be/5gsSx3DVY_k)    
Так же в пакаджах можно указывать и данные для recorder. Общие данные для всей системы — `db_url`, `purge_keep_days` и т.п. — указываем разово в `configuration.yaml` —
```yaml
recorder:
  db_url: sqlite:////config/home-assistant_v2.db
  purge_keep_days: 14
```
А вот что именно хранить — можем писать в пакадже.    
Вот в качестве примера часть пакаджа для кейса управления термоголовкой из моего обзора [Zigbee термоголовка Moes TV 01, часть 2 — практическое использование в Home Assistant](https://youtu.be/Y0bkyzhKHh8)    
От показанного в обзоре он отличается добавленной секцией для recorder в которой указаны две сущности — термостат и датчик температуры.
```yaml
living_heat_1:
## Гостиная термоголовка 1

    recorder:
      include:
        entities:
           - climate.0x2c1165fffec61c89
           - sensor.0x00158d00015aebb6_temperature

    homeassistant:
      customize:
        
        climate.0x2c1165fffec61c89:
          friendly_name: Гостиная, TRV 1
        lock.0x2c1165fffec61c89_child_lock:
          friendly_name: Гостиная, TRV 1 замок
```
Так гораздо удобнее и полностью соответствует базовой концепции — все в одном файле.

____
#### Поддержать развитие проекта *Умный дом с Alex Kvazis*    
<a href="https://www.youtube.com/channel/UCcq9onYHbs6go3kDpfBoqhg/join" target="_blank"><img src="https://raw.githubusercontent.com/kvazis/training/master/lessons/img/youtube.png" alt="Youtube Sponsorship" style="height: 41px !important;width: 174px !important;box-shadow: 0px 3px 2px 0px rgba(190, 190, 190, 0.5) !important;-webkit-box-shadow: 0px 3px 2px 0px rgba(190, 190, 190, 0.5) !important;" ></a>
<a href="https://www.patreon.com/alex_kvazis" target="_blank"><img src="https://raw.githubusercontent.com/kvazis/training/master/lessons/img/patreon-button.png" alt="Patreon Support" style="height: 41px !important;width: 174px !important;box-shadow: 0px 3px 2px 0px rgba(190, 190, 190, 0.5) !important;-webkit-box-shadow: 0px 3px 2px 0px rgba(190, 190, 190, 0.5) !important;" ></a>
<a href="https://www.buymeacoffee.com/greatkvazis" target="_blank"><img src="https://raw.githubusercontent.com/kvazis/training/master/lessons/img/buymeacoffee.png" alt="Buy Me A Coffee" style="height: 41px !important;width: 174px !important;box-shadow: 0px 3px 2px 0px rgba(190, 190, 190, 0.5) !important;-webkit-box-shadow: 0px 3px 2px 0px rgba(190, 190, 190, 0.5) !important;" ></a>
<a href="https://www.paypal.com/paypalme/greatkvazis" target="_blank"><img src="https://raw.githubusercontent.com/kvazis/training/master/lessons/img/paypal.png" alt="PayPal Me" style="height: 41px !important;width: 174px !important;box-shadow: 0px 3px 2px 0px rgba(190, 190, 190, 0.5) !important;-webkit-box-shadow: 0px 3px 2px 0px rgba(190, 190, 190, 0.5) !important;" ></a>

#### Или перевод любой суммы на -     
* Webmoney - Z243592584952
* BTC - 1Gzr7WQugfnPuWVawu47EiCMTDUBqCAshj
* ETH - 0xa0ce3E29Cf537013649Ae9cdbc08C4853fF91FAc
* LTC - ltc1qs493yk2wk9ywx5h6aruk4p9zm75hx42ekv4ym2
* TRX - TFTCLqvS1tMBwokRHBwz1TCDJ4oD1Z5zPk